function initMap(){var e={lat:60.128,lng:18.643};map=new google.maps.Map(document.getElementById("map"),{zoom:2,center:e})}function getMyLocation(e,t){navigator.geolocation.getCurrentPosition(function(n){var o={lat:n.coords.latitude,lng:n.coords.longitude};e.setCenter(o),e.setZoom(10),getCity(t,o)})}function getCity(e,t){var n="";e.geocode({location:t},function(e,t){if("OK"===t)for(var o=0;o<e.length;o++)for(var r=0;r<e[o].types.length;r++)"postal_town"===e[o].types[r]&&loadStoreSearchData(n=e[o].address_components[0].short_name);else alert(t)})}function geocodeAddress(e,t,n,o){var n=n;e.geocode({address:n},function(e,r){if("OK"===r)for(var a=0;a<e.length;a++){t.setCenter(e[a].geometry.location),t.setZoom(12);var s=new google.maps.Marker({map:t,position:e[a].geometry.location,url:o,title:n});google.maps.event.addListener(s,"click",function(){window.location.href="store.html?id="+s.url})}else alert("Something went wrong when geocoding "+r)})}function getStoreID(){var e=location.href;return e.substring(e.indexOf("?id=")+4)}function loadStoreAddress(){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.systembolaget.se/api/assortment/stores/xml",success:function(e){for(var t=getStoreID(),n=e.getElementsByTagName("ButikOmbud"),o=0;o<n.length;o++)if(n[o].childNodes[1].textContent===t){var r=n[o].childNodes[6].textContent.toLowerCase();r=r.charAt(0).toUpperCase()+r.slice(1),document.getElementById("address").innerHTML+=n[o].childNodes[3].textContent+" ",document.getElementById("address").innerHTML+=n[o].childNodes[5].textContent+" ",document.getElementById("address").innerHTML+=r}},datatype:"xml",error:function(){alert("Error: Something went wrong with loading stores "),console.log(status)}})}function buildSearchResultTable(e,t,n){var o={name:"Namn",group:"Sort",price:"Pris",drinkSugestion:"Drink förslag"},r=Mustache.render("<tr><th>{{name}}</th><th>{{group}}</th><th>{{price}}</th></tr>",o);console.log(t),console.log(e);for(var a=0;a<t;a++){var s={Name:e[a].childNodes[3].textContent+" "+e[a].childNodes[4].textContent,Varugrupp:e[a].childNodes[10].textContent,Prisinklmoms:e[a].childNodes[5].textContent};"Varugrupp"!=e[a].childNodes[10].nodeName&&(s.Varugrupp=e[a].childNodes[11].textContent),r+=Mustache.render("<tr><td>{{{Name}}}</td><td>{{{Varugrupp}}}</td><td>{{{Prisinklmoms}}}</td></tr>",s)}$("#searchResult").html(r),getDrinkSugestions(n)}function getDrinkSugestions(e){var t=getDrinks(e,3);document.getElementById("drinkSugestions").innerHTML="Drink förslag för "+e+": ";for(var n=0;n<t.drinks.length;n++){var o="drink.html?i="+t.drinks[n].idDrink,r=document.createElement("A"),a=document.createTextNode(t.drinks[n].strDrink+", ");r.appendChild(a),r.setAttribute("href",o),document.getElementById("drinkSugestions").appendChild(r)}}function getDrinks(e,t){var n,o="http://www.thecocktaildb.com/api/json/v1/1/filter.php?i="+e;return $.ajax({url:o,async:!1,success:function(e){n='{"drinks":[';for(var o=".",r=0;r<t;r++){do{var a=Math.floor(Math.random()*e.drinks.length)}while(o.indexOf("."+a+".")>0&&"."!==o);o+=a+".",n+=JSON.stringify(e.drinks[a])}return n+="]}",n=replaceAll(n,"}{","},{")},error:function(e,t,n){alert("något gick fel med API-anslutningen")}}),JSON.parse(n)}function replaceAll(e,t,n){return e.replace(new RegExp(t,"g"),n)}function placeStores(e,t,n){for(var o=0;o<e.length;o++){var r=t.toLowerCase();r=r.charAt(0).toUpperCase()+r.slice(1),geocodeAddress(geocoder,map,e[o]+" "+r+" Sverige",n[o])}}function loadStoreSearchData(e){console.log("Connection");$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.systembolaget.se/api/assortment/stores/xml",success:function(t){findStore(e,t)},datatype:"xml",error:function(){alert("Error: Something went wrong with loding stores "),console.log(status)}})}function findStore(e,t){console.log("searching for store");for(var n=[],o=[],r=0;r<t.getElementsByTagName("ButikOmbud").length;r++)t.getElementsByTagName("ButikOmbud")[r].childNodes[6].textContent===e.toUpperCase()&&"Ombud"!==t.getElementsByTagName("ButikOmbud")[r].childNodes[0].textContent&&(n.push(t.getElementsByTagName("ButikOmbud")[r].childNodes[3].textContent),o.push(t.getElementsByTagName("ButikOmbud")[r].childNodes[1].textContent));placeStores(n,e.toUpperCase(),o)}function loadStoreInventoryData(e,t){console.log("Seaching for drink");$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.systembolaget.se/api/assortment/stock/xml",success:function(n){getStoreIventory(e,t,n)},datatype:"xml",error:function(){alert("Error: Something went wrong"),console.log(status)}})}function getStoreIventory(e,t,n){console.log("Getting store inventory");for(var o=[],r=0;r<n.getElementsByTagName("Butik").length;r++)if(n.getElementsByTagName("Butik")[r].getAttribute("ButikNr")===t){for(var a=0;a<n.getElementsByTagName("Butik")[r].childNodes.length;a++)o.push(n.getElementsByTagName("Butik")[r].childNodes[a]);r=n.getElementsByTagName("Butik").length}loadArtikelInfoDataForStore(o,e)}function loadArtikelInfoDataForStore(e,t){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.systembolaget.se/api/assortment/products/xml",success:function(n){getArtikelInfoForStore(e,n,t)},datatype:"xml",error:function(){alert("Error: Something went wrong"),console.log(status)}})}function getArtikelInfoForStore(e,t,n){var o=[];console.log("searching for drink :"+n);for(var r=0;r<e.length/2;r++)for(var a=0;a<t.getElementsByTagName("artikel").length;a++)t.getElementsByTagName("artikel")[a].childNodes[0].textContent==e[r].textContent&&(t.getElementsByTagName("artikel")[a].childNodes[3].textContent.toLowerCase().includes(n)||t.getElementsByTagName("artikel")[a].childNodes[3].textContent.toLowerCase()===n||t.getElementsByTagName("artikel")[a].childNodes[4].textContent.toLowerCase().includes(n)||t.getElementsByTagName("artikel")[a].childNodes[10].textContent.toLowerCase()===n)&&o.push(t.getElementsByTagName("artikel")[a]);buildSearchResultTable(o,o.length,n)}function loadAllArtikels(){$.ajax({url:"https://cors-anywhere.herokuapp.com/https://www.systembolaget.se/api/assortment/products/xml",success:function(e){getAllInventory(e)},datatype:"xml",error:function(){alert("Error: Something went wrong"),console.log(status)}})}function getAllInventory(e){for(var t=[],n=e.getElementsByTagName("artikel").length,o=0;o<n;o++)t.push(e.getElementsByTagName("artikel")[o]);console.log(t[1])}function getDrink(e){var t="http://www.thecocktaildb.com/api/json/v1/1/lookup.php"+e;return $.ajax({url:t,async:!1,success:function(e){},error:function(e,t,n){alert("något gick fel med API-anslutningen")}}).responseJSON}function renderData(e){$("title").append(e.drinks[0].strDrink),$("#category").append(e.drinks[0].strCategory),$("#name").append(e.drinks[0].strDrink),$("#desc").append(e.drinks[0].strInstructions),$("#pic").append("<img id='pic' src='"+e.drinks[0].strDrinkThumb+"'>");for(var t=fixIngredients(e),n=0;n<t.length;n++){var o="<li>"+t[n]+"</li>";$("#ingredients").append(o)}}function fixIngredients(e){for(var t=JSON.stringify(e),n=[],o=1;o<15;o++){var r=t.substring(t.indexOf("strMeasure"+o),t.indexOf("strMeasure"+(o+1)));r=r.substring(r.indexOf(":")+2,r.lastIndexOf(",")-1);var a=t.substring(t.indexOf("strIngredient"+o),t.indexOf("strIngredient"+(o+1))),s=r+(a=a.substring(a.indexOf(":")+2,a.lastIndexOf(",")-1));if(" "===s)break;n.push(s)}return n}function replaceAll(e,t,n){return e.replace(new RegExp(t,"g"),n)}initMap();var geocoder=new google.maps.Geocoder,map;$(document).ready(function(){getStoreID(),loadStoreAddress(),document.getElementById("searchDrinkBtn").addEventListener("click",function(){loadStoreInventoryData(document.getElementById("searchDrinkInput").value.toLowerCase(),getStoreID())})}),$(document).ready(function(){$map=$("#map").hide(),$("#searchButton").click(function(){$map.slideDown(function(){loadStoreSearchData(document.getElementById("citySearchInput").value),initMap()})}),$("#useMyLocation").click(function(){$map.slideDown(function(){getMyLocation(map,geocoder),initMap()})}),$("#ageConfirmation").dialog({dialogClass:"no-close",resizable:!1,draggable:!1,height:"auto",width:"auto",modal:!0,autoOpen:!1,buttons:{"Jag är 20 år gammal eller äldre":function(){$(this).dialog("close")},"Jag är under 20 år gammal":function(){window.location.href="under20.html"}}})}),$(document).ready(function(){}),$(document).ready(function(){var e=window.location.href;renderData(getDrink(e.substring(e.indexOf("?"),e.length)))});